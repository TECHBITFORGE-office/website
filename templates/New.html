<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>APINOW - code studio</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>

    <!-- JSZip for Zipping Files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        neon: {
                            blue: '#00f3ff',
                            purple: '#bc13fe',
                            pink: '#ff0055',
                            bg: '#050508',
                            surface: '#0f0f16',
                            light: '#1a1a24'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    boxShadow: {
                        'neon-blue': '0 0 5px theme("colors.neon.blue"), 0 0 10px theme("colors.neon.blue")',
                        'neon-purple': '0 0 5px theme("colors.neon.purple"), 0 0 10px theme("colors.neon.purple")',
                        'glass': '0 8px 32px 0 rgba(0, 0, 0, 0.37)',
                        'code_studio-glow': '0 0 15px rgba(0, 243, 255, 0.3), 0 0 25px rgba(188, 19, 254, 0.2)',
                    }
                }
            }
        }
    </script>

    <style>
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #050508; }
        ::-webkit-scrollbar-thumb { background: #1a1a24; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #bc13fe; }

        body { background-color: #050508; color: #e2e8f0; overflow: hidden; }

        .glass-panel { background: rgba(15, 15, 22, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        .preview-frame { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* DeepSite Input Styles */
        .code_studio-input-container {
            position: fixed; bottom: 24px; right: 24px; width: 90%; max-width: 500px;
            background-color: rgba(15, 15, 22, 0.95); backdrop-filter: blur(16px);
            border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.47), 0 0 30px rgba(0,243,255,0.1);
            padding: 12px; display: flex; flex-direction: column; gap: 8px; z-index: 100;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        .code_studio-input-field {
            display: flex; align-items: center; background-color: rgba(5, 5, 8, 0.6);
            border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 8px 12px; color: #e2e8f0;
        }
        .code_studio-input-field input { flex-grow: 1; background: transparent; border: none; outline: none; color: inherit; font-size: 0.9rem; padding-right: 8px; }
        
        .code_studio-actions { display: flex; align-items: center; justify-content: space-between; gap: 8px; }
        
        .code_studio-button {
            display: flex; align-items: center; padding: 6px 12px; border-radius: 6px;
            font-size: 0.8rem; font-weight: 500; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;
        }
        .code_studio-button.enhance { background: linear-gradient(to right, #00f3ff, #bc13fe); color: white; border: 1px solid #00f3ff; }
        .code_studio-button.model { background-color: rgba(30, 30, 45, 0.7); border: 1px solid rgba(255, 255, 255, 0.1); color: #a0aec0; }
        
        .code_studio-send-button {
            width: 36px; height: 36px; background-color: rgba(0, 243, 255, 0.2); border: 1px solid #00f3ff;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #00f3ff; font-size: 1rem; cursor: pointer; transition: all 0.3s ease;
        }
        .code_studio-send-button:hover { background-color: #00f3ff; color: #050508; transform: translateY(-1px); }
        .code_studio-send-button.loading { animation: spin 1s linear infinite; pointer-events: none; opacity: 0.7; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* AI Streaming Terminal Overlay */
        #ai-terminal {
            position: absolute; bottom: 0; left: 0; right: 0; height: 0;
            background: rgba(5, 5, 8, 0.95); border-top: 1px solid rgba(255,255,255,0.1);
            transition: height 0.3s ease; overflow: hidden; z-index: 20;
            font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #a0aec0;
            display: flex; flex-direction: column;
        }
        #ai-terminal.open { height: 200px; }
        #chatMessages {
            flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; gap: 0.5rem;
        }
        
        /* Tab Styles matching logic */
        .tab { border: 1px solid rgba(255,255,255,0.1); cursor: pointer; user-select: none; }
        .tab.active { border-bottom: 2px solid #00f3ff; color: #fff; background: rgba(0, 243, 255, 0.1); }
    </style>
</head>
<body class="h-screen w-full flex flex-col text-sm">

    <!-- CUSTOM NAVBAR -->
    <custom-navbar></custom-navbar>

    <!-- Main Workspace (Added padding-top to account for fixed navbar) -->
    <main class="flex-1 flex overflow-hidden relative pt-[70px]">
        
        <!-- Sidebar: File Explorer -->
        <aside class="w-64 bg-neon-surface border-r border-white/5 flex flex-col hidden md:flex">
            <div class="p-4 border-b border-white/5 flex justify-between items-center">
                <h3 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Explorer</h3>
                <button onclick="initEditor()" class="text-gray-500 hover:text-neon-blue"><i class="fa-solid fa-rotate"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="file-explorer-list">
                <!-- Files will be injected here via JS -->
            </div>

            <div class="p-4 border-t border-white/5 text-xs text-gray-500">
                <div class="flex items-center justify-between">
                    <span>Repo:</span>
                    <span id="repo-name-display" class="text-neon-blue truncate max-w-[80px]">-</span>
                </div>
            </div>
        </aside>

        <!-- Middle: Code Editor -->
        <section class="flex-1 flex flex-col bg-neon-bg relative min-w-0">
            
            <!-- Editor Tabs -->
            <div class="h-10 bg-neon-surface border-b border-white/5 flex items-end px-2 gap-1 overflow-x-auto" id="editor-tabs">
                <!-- Tabs injected via JS -->
            </div>

            <!-- Editor Canvas -->
            <div class="flex-1 relative flex overflow-hidden">
                <!-- Ace Editor Container -->
                <div id="editor" class="w-full h-full text-sm"></div>
            </div>

            <!-- Terminal / Chat Overlay -->
            <div id="ai-terminal">
                <div class="bg-black/40 px-4 py-1 text-xs text-neon-purple font-bold border-b border-white/10 flex justify-between">
                    <span>> AI Output Stream</span>
                    <button onclick="document.getElementById('ai-terminal').classList.remove('open')" class="text-gray-500 hover:text-white">✕</button>
                </div>
                <div id="chatMessages">
                    <!-- Chat bubbles go here -->
                </div>
            </div>

            <!-- Footer Status Bar -->
            <div class="h-6 bg-neon-blue/5 border-t border-white/5 flex items-center justify-end px-4 gap-4 text-[10px] text-neon-blue font-mono">
                <span id="cursor-pos">Ln 1, Col 1</span>
                <span>UTF-8</span>
                <span id="lang-display">HTML</span>
                <span id="branch-display"><i class="fa-solid fa-code-branch mr-1"></i>main</span>
            </div>
        </section>

        <!-- Right: Preview Area -->
        <aside class="hidden lg:flex flex-col border-l border-white/5 bg-[#000] relative transition-all duration-500 ease-in-out" id="preview-container" style="width: 45%;">
            <div class="h-10 bg-neon-surface border-b border-white/5 flex items-center justify-between px-3">
                <div class="flex items-center gap-2 bg-black/40 rounded px-2 py-1 w-full max-w-[300px]">
                    <i class="fa-solid fa-lock text-[10px] text-green-400"></i>
                    <span class="text-xs text-gray-400 truncate">https://preview.neon.app</span>
                </div>
                
                <div class="flex gap-2 items-center">
                    <button class="text-gray-500 hover:text-white"><i class="fa-solid fa-up-right-from-square"></i></button>
                </div>
            </div>

            <div class="flex-1 bg-[#0d0d12] flex items-center justify-center overflow-hidden p-4 bg-dots">
                <div id="preview-frame-wrapper" class="preview-frame w-full h-full bg-white rounded-lg overflow-hidden shadow-2xl relative group">
                     <iframe src="about:blank" class="w-full h-full border-none" id="demo-iframe"></iframe>
                </div>
            </div>
        </aside>
    </main>

    <!-- Chat Input Box -->
    <div class="code_studio-input-container" id="input-container">
        <div class="code_studio-input-field">
            <input type="text" id="chatInput" placeholder="Ask me anything..." class="placeholder-gray-500">
            <i class="fa-solid fa-dice dice-icon"></i>
        </div>
        <div class="code_studio-actions">
            <div class="flex gap-2">
                <button class="code_studio-button enhance">
                    <i class="fa-solid fa-wand-magic-sparkles mr-1"></i>Enhance
                </button>
                <button class="code_studio-button model">
                    <i class="fa-solid fa-code-branch mr-1"></i>code_studio-v3.2-exp
                </button>
            </div>
            <button class="code_studio-send-button" id="sendBtn">
                <i class="fa-solid fa-arrow-up"></i>
            </button>
        </div>
    </div>

    <script>
        /* -------------------------------------------------------
           CUSTOM NAVBAR WEB COMPONENT (DARK NEON VERSION)
           ------------------------------------------------------- */
        class CustomNavbar extends HTMLElement {
            connectedCallback() {
                this.attachShadow({ mode: "open" });
                this.render();
                this.initAuthListener();
            }

            render(isLoggedIn = false, userData = null) {
                // LOGIC TO EXTRACT USER IMAGE OR USE DEFAULT
                let avatarURL = localStorage.getItem("avatar_url") ;
                
                if (userData?.avatar_url) {
                    // If absolute URL (http/https), use it directly. Otherwise, assume relative to origin.
                    if (userData.avatar_url.startsWith('http')) {
                        avatarURL = userData.avatar_url;
                    } else {
                        avatarURL = new URL(userData.avatar_url, window.location.origin).href;
                    }
                }

                this.shadowRoot.innerHTML = `
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                <style>
                    :host { display: block; font-family: 'Inter', sans-serif; }
                    nav {
                        background: rgba(5, 5, 8, 0.85); backdrop-filter: blur(16px);
                        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5); padding: 0 1.5rem;
                        display: flex; justify-content: space-between; align-items: center;
                        position: fixed; top: 0; left: 0; right: 0; z-index: 10000;
                        border-bottom: 1px solid rgba(255,255,255,0.05); height: 70px;
                    }
                    nav::after {
                        content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 1px;
                        background: linear-gradient(90deg, transparent, #00f3ff, #bc13fe, transparent); opacity: 0.7;
                    }
                    .logo { display: flex; align-items: center; gap: 0.5rem; text-decoration: none; }
                    .logo img { height: 32px; filter: drop-shadow(0 0 5px rgba(0, 243, 255, 0.6)); }
                    .logo-text { color: #fff; font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; }
                    .view-toggle {
                        position: absolute; left: 50%; transform: translateX(-50%);
                        display: flex; background: rgba(255, 255, 255, 0.05); padding: 4px;
                        border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);
                    }
                    .toggle-btn {
                        display: flex; align-items: center; gap: 6px; padding: 6px 12px;
                        border-radius: 6px; border: none; background: transparent; color: #94a3b8;
                        font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s ease;
                    }
                    .toggle-btn.active { background: rgba(255, 255, 255, 0.1); color: #fff; }
                    .nav-actions { display: flex; align-items: center; gap: 1rem; }
                    .btn-signin { padding: 0.5rem 1.2rem; border-radius: 0.5rem; border: 1px solid rgba(0,243,255,0.3); color: #00f3ff; text-decoration: none; font-weight: 600; font-size: 0.9rem; transition: all 0.3s; }
                    .btn-signin:hover { background: rgba(0,243,255,0.1); color: white; box-shadow: 0 0 10px rgba(0,243,255,0.4); }
                    .btn-signup { padding: 0.5rem 1.2rem; border-radius: 0.5rem; background: linear-gradient(135deg, #00f3ff, #bc13fe); color: #000; font-weight: 700; text-decoration: none; font-size: 0.9rem; transition: all 0.3s; }
                    .btn-signup:hover { box-shadow: 0 0 20px rgba(0,243,255,0.6); color: white; }
                    .outline-none { display: flex; align-items: center; gap: 0.8rem; background: rgba(255,255,255,0.03); padding: 0.3rem 0.8rem; border-radius: 2rem; border: 1px solid rgba(255,255,255,0.1); }
                    .user-avatar { width: 34px; height: 34px; border-radius: 50%; object-fit: cover; border: 2px solid transparent; cursor: pointer; }
                    .dropdown { display: none; position: absolute; top: 60px; right: 1.5rem; background: #0a0a0f; border: 1px solid rgba(255,255,255,0.1); border-radius: 0.8rem; width: 200px; padding: 0.5rem; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
                    .dropdown.open { display: block; }
                    .dropdown a { display: flex; align-items: center; gap: 0.5rem; padding: 0.7rem 1rem; color: #d1d5ff; text-decoration: none; border-radius: 0.5rem; font-size: 0.9rem; }
                    .dropdown a:hover { background: rgba(255,255,255,0.05); color: #fff; }
                    @media (max-width: 768px) { .view-toggle, .nav-actions { display: none; } }
                </style>

                <nav>
                    <a class="logo" href="/">
                         <img src="/9020930.png" onerror="this.style.display='none';this.nextElementSibling.style.display='block'" alt="Logo">
                         <span class="logo-text" style="display:none">NEON</span>
                    </a>

                    <div class="view-toggle">
                        <button class="toggle-btn active" id="nav-btn-desktop"><i class="fa-solid fa-desktop"></i> Desktop</button>
                        <button class="toggle-btn" id="nav-btn-mobile"><i class="fa-solid fa-mobile-screen"></i> Mobile</button>
                    </div>

                    <div class="nav-actions">
                    ${isLoggedIn ? `
                        <div class="outline-none">
                            <div class="avatar-container"><img src="${avatarURL}" class="user-avatar user-dropdown"></div>
                            <button class="toggle-btn menu-btn">☰</button>
                        </div>
                        <div class="dropdown">
                            <div style="padding:0.5rem 1rem; color:#64748b; font-size:0.75rem; font-weight:bold;">${userData?.full_name || 'Account'}</div>
                            <a href="#" id="action-save"><i class="fa-solid fa-floppy-disk"></i> Save Project</a>
                            <a href="#" id="action-download"><i class="fa-solid fa-file-zipper"></i> Download ZIP</a>
                            <div style="height:1px; background:rgba(255,255,255,0.1); margin:0.4rem 0;"></div>
                            <a href="/signout" style="color:#ff4b91;">Sign Out</a>
                        </div>` 
                    : `
                        <a href="/signin" class="btn-signin">Sign In</a>
                        <a href="/signup" class="btn-signup">Get Started</a>`}
                    </div>
                </nav>`;
                
                this.initDropdown();
                this.initViewToggle();
                this.initActionButtons();
            }

            initDropdown() {
                const dropdown = this.shadowRoot.querySelector(".dropdown");
                const menuBtn = this.shadowRoot.querySelector(".menu-btn");
                const avatar = this.shadowRoot.querySelector(".user-avatar");
                
                const toggle = (e) => { 
                    e.stopPropagation(); 
                    dropdown.classList.toggle("open"); 
                };

                if (menuBtn && dropdown) menuBtn.onclick = toggle;
                if (avatar && dropdown) avatar.onclick = toggle;
                
                document.addEventListener("click", () => dropdown?.classList.remove("open"));
            }

            initViewToggle() {
                const btnD = this.shadowRoot.getElementById('nav-btn-desktop');
                const btnM = this.shadowRoot.getElementById('nav-btn-mobile');
                if(btnD && btnM) {
                    btnD.onclick = () => { btnD.classList.add('active'); btnM.classList.remove('active'); window.setPreview('desktop'); };
                    btnM.onclick = () => { btnM.classList.add('active'); btnD.classList.remove('active'); window.setPreview('mobile'); };
                }
            }

            initActionButtons() {
                const saveBtn = this.shadowRoot.getElementById('action-save');
                const dlBtn = this.shadowRoot.getElementById('action-download');
                if(saveBtn) saveBtn.onclick = () => window.dispatchEvent(new CustomEvent('custom-navbar:save'));
                if(dlBtn) dlBtn.onclick = () => window.dispatchEvent(new CustomEvent('custom-navbar:download'));
            }

            async initAuthListener() {
                const apiKey = localStorage.getItem("api_key");
                // IF NOT LOGGED IN -> SHOW SIGN IN BUTTONS
                if (!apiKey) return this.render(false);
                
                try {
                    // REAL FETCH TO EXTRACT USER IMAGE & DATA
                    const response = await fetch(`/get_user`, {
                        method: "GET",
                        headers: { 
                            "Authorization": `Bearer ${apiKey}`,
                            "Content-Type": "application/json"
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        // Check if data array exists and has items
                        const userObj = data.data && data.data.length > 0 ? data.data[0] : null;
                        
                        if (userObj) {
                            this.render(true, userObj);
                            return;
                        }
                    }
                    // Fallback if api key invalid
                    this.render(false);
                } catch (e) { 
                    console.error("Auth check error:", e);
                    this.render(false); 
                }
            }
        }
        customElements.define("custom-navbar", CustomNavbar);


        // ------------------------------------------------------------
        // ---------------------- APP LOGIC ---------------------------
        // ------------------------------------------------------------

        let editor;
        let currentFile = "index.html";
        let projectFiles = { "index.html": "" };
        let fileTabs = {};

        // Set API Key in localStorage for testing if needed: localStorage.setItem("api_key", "your_key");
        const API_KEY = localStorage.getItem("api_key"); 

        // --- EDITOR INIT ---
        function initEditor() {
            editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai"); // Dark theme matches neon
            editor.session.setMode("ace/mode/html");
            editor.setOptions({
                fontSize: "14px",
                showPrintMargin: false,
                enableBasicAutocompletion: true,
                enableLiveAutocompletion: true,
                fontFamily: "'JetBrains Mono', monospace"
            });

            if (!projectFiles["index.html"].trim()) {
                projectFiles["index.html"] = defaultTemplate();
            }

            editor.setValue(projectFiles["index.html"], -1);
            editor.session.on("change", updatePreview);

            refreshFileTabs();
            refreshSidebar();
            switchFile("index.html");
        }

        function defaultTemplate() {
            return ``;
        }

        // --- FILE & TABS MANAGEMENT ---
        function refreshFileTabs() {
            const container = document.getElementById("editor-tabs");
            container.innerHTML = ''; // Clear existing
            
            Object.keys(projectFiles).forEach(fileName => {
                const tab = document.createElement("div");
                const isActive = currentFile === fileName;
                // Style matches HTML/CSS block
                tab.className = isActive 
                    ? "tab-active h-9 px-4 flex items-center gap-2 rounded-t-md text-xs font-medium cursor-pointer select-none min-w-[100px] justify-between"
                    : "tab-inactive h-9 px-4 flex items-center gap-2 rounded-t-md text-xs font-medium cursor-pointer transition-colors select-none min-w-[100px]";
                
                let iconClass = getIconForFile(fileName);
                
                tab.innerHTML = `
                    <div class="flex items-center gap-2">
                        <i class="${iconClass}"></i> ${fileName}
                    </div>
                    ${isActive ? '<i class="fa-solid fa-xmark text-gray-500 hover:text-white"></i>' : ''}
                `;
                tab.onclick = () => switchFile(fileName);
                container.appendChild(tab);
            });
        }

        function refreshSidebar() {
            const container = document.getElementById("file-explorer-list");
            container.innerHTML = '';

            Object.keys(projectFiles).forEach(fileName => {
                const div = document.createElement('div');
                const isActive = currentFile === fileName;
                div.className = `flex items-center gap-2 px-3 py-2 rounded-md text-gray-400 hover:text-white hover:bg-white/5 cursor-pointer transition-colors ${isActive ? 'bg-neon-blue/10 text-white border-l-2 border-neon-blue' : ''}`;
                div.onclick = () => switchFile(fileName);
                
                let iconClass = getIconForFile(fileName);
                div.innerHTML = `<i class="${iconClass}"></i><span class="truncate">${fileName}</span>`;
                container.appendChild(div);
            });
        }

        function getIconForFile(fileName) {
            if (fileName.endsWith('.html')) return 'fa-brands fa-html5 text-orange-500';
            if (fileName.endsWith('.css')) return 'fa-brands fa-css3-alt text-blue-400';
            if (fileName.endsWith('.js')) return 'fa-brands fa-js text-yellow-400';
            return 'fa-solid fa-file text-gray-500';
        }

        function createFileTab(fileName, content) {
            projectFiles[fileName] = content;
            refreshFileTabs();
            refreshSidebar();
            switchFile(fileName);
        }

        function switchFile(fileName) {
            currentFile = fileName;
            const ext = fileName.split(".").pop();
            const mode = ext === 'js' ? 'javascript' : ext;
            editor.session.setMode(`ace/mode/${mode}`);
            editor.setValue(projectFiles[fileName], -1); // -1 moves cursor to start
            
            refreshFileTabs();
            refreshSidebar();
            updatePreview();
            
            // Update footer
            document.getElementById('lang-display').textContent = ext.toUpperCase();
        }

        // --- PREVIEW LOGIC ---
        function updatePreview() {
            // Save current state
            projectFiles[currentFile] = editor.getValue();

            if (projectFiles["index.html"]) {
                let html = projectFiles["index.html"];
                // Inject CSS if it exists
                if (projectFiles["style.css"]) {
                    html = html.replace("</head>", `<style>${projectFiles["style.css"]}</style></head>`);
                } else if (projectFiles["index.css"]) {
                    html = html.replace("</head>", `<style>${projectFiles["index.css"]}</style></head>`);
                }
                // Inject JS if it exists
                if (projectFiles["script.js"]) {
                    html = html.replace("</body>", `<script>${projectFiles["script.js"]}<\/script></body>`);
                }
                
                document.getElementById("demo-iframe").srcdoc = html;
            }
        }

        function setPreview(mode) {
            const wrapper = document.getElementById('preview-frame-wrapper');
            if (mode === 'desktop') {
                wrapper.style.width = "100%";
                wrapper.style.height = "100%";
                wrapper.style.borderRadius = "0.5rem";
                wrapper.style.border = "none";
            } else {
                wrapper.style.width = "375px";
                wrapper.style.height = "80%";
                wrapper.style.borderRadius = "2rem";
                wrapper.style.border = "4px solid #333";
            }
        }

        // ------------------------------------------------------------
        // ---------------------- CHAT SYSTEM -------------------------
        // ------------------------------------------------------------
        
        const sendBtn = document.getElementById("sendBtn");
        const chatInput = document.getElementById("chatInput");

        sendBtn.addEventListener("click", sendMessage);
        chatInput.addEventListener("keypress", e => {
            if (e.key === "Enter") sendMessage();
        });

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            const chatMessages = document.getElementById("chatMessages");
            const terminal = document.getElementById("ai-terminal");
            terminal.classList.add("open"); // Auto open terminal

            // USER MESSAGE
            const userMsg = document.createElement("div");
            userMsg.className = "bg-neon-blue/20 border border-neon-blue/30 rounded-lg p-2 ml-8 text-white self-end text-right";
            userMsg.innerHTML = `<p class="text-xs font-mono">${message}</p>`;
            chatMessages.appendChild(userMsg);

            chatInput.value = "";

            // AI MESSAGE LOADING
            const aiMsg = document.createElement("div");
            aiMsg.className = "bg-gray-800/80 border border-white/10 rounded-lg p-2 mr-8 text-gray-300 font-mono text-xs whitespace-pre-wrap";
            aiMsg.textContent = "Thinking...";
            chatMessages.appendChild(aiMsg);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Using the endpoint from your snippet
                const response = await fetch("/ask", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": "Bearer " + (API_KEY || "mock-token") 
                    },
                    body: JSON.stringify({ prompt: message })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder("utf-8");

                aiMsg.textContent = ""; // Clear "Thinking..."
                let fullText = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    fullText += chunk;
                    aiMsg.textContent += chunk;
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }

                parseAIResponse(fullText);

            } catch (err) {
                aiMsg.textContent = "⚠️ Error: " + err.message;
                aiMsg.classList.add("text-red-400");
            }
        }

        // --- PARSE AI FILES ---
        function parseAIResponse(text) {
            // The regex from your snippet to extract file blocks
            const filePattern = /<<<<<<< NEW_FILE_START (.*?) >>>>>>> NEW_FILE_END[\s\S]*?```[a-zA-Z]*\n([\s\S]*?)```/g;

            let match;
            let foundFiles = [];

            while ((match = filePattern.exec(text)) !== null) {
                foundFiles.push({
                    name: match[1].trim(),
                    content: match[2].trim()
                });
            }

            if (foundFiles.length) {
                const chatMessages = document.getElementById("chatMessages");
                
                const infoMsg = document.createElement("div");
                infoMsg.className = "bg-green-900/30 border border-green-500/30 text-green-400 rounded p-2 text-xs font-mono mt-2";
                infoMsg.textContent = `⚡ Generated files: ${foundFiles.map(f => f.name).join(", ")}`;
                chatMessages.appendChild(infoMsg);
                chatMessages.scrollTop = chatMessages.scrollHeight;

                foundFiles.forEach(f => {
                    createFileTab(f.name, f.content);
                });
                
                // Force refresh preview if index.html was touched
                if(foundFiles.some(f => f.name === 'index.html')) updatePreview();
            }
        }

        // --- DOWNLOAD & SAVE ACTIONS ---
        // Hooked to custom-navbar events
        window.addEventListener('custom-navbar:save', () => {
            console.log('Saving project...', projectFiles);
            // Add your backend Save call here
            alert("Project saved (console log)");
        });

        window.addEventListener('custom-navbar:download', () => {
            const zip = new JSZip();
            for (const [fileName, content] of Object.entries(projectFiles)) {
                zip.file(fileName, content);
            }
            zip.generateAsync({ type: "blob" }).then(blob => {
                saveAs(blob, "neon-project.zip");
            });
        });

        // --- INITIALIZATION ---
        window.addEventListener("load", () => {
            initEditor();
            // Ensure mobile/desktop toggle works globally if clicked outside component logic
            window.setPreview = setPreview; 
        });

    </script>
</body>
</html>